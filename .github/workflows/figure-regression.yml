# Figure Regression: プロット結果のピクセル差分で変更を検出
# ベースライン画像と比較し、意図しない変更を検知

name: Figure Regression

on:
  pull_request:
    paths:
      - '**/generate_*.py'
      - '**/plot_*.py'
      - '**/visualize_*.py'
      - 'FEM/plot_*.py'
      - 'data_5species/**/plot*.py'
  workflow_dispatch:

concurrency:
  group: figure-regression-${{ github.ref }}
  cancel-in-progress: true

jobs:
  figure-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install deps
        run: pip install numpy scipy matplotlib pillow pytest

      - name: Create test figure script
        run: |
          cat > test_figure_regression.py << 'SCRIPT'
          """Minimal figure regression test: generate a plot and check it exists."""
          import matplotlib
          matplotlib.use('Agg')
          import matplotlib.pyplot as plt
          import numpy as np
          from pathlib import Path

          out = Path("figure_test_output.png")
          fig, ax = plt.subplots()
          x = np.linspace(0, 1, 100)
          ax.plot(x, np.sin(2 * np.pi * x))
          ax.set_title("Regression test figure")
          fig.savefig(out, dpi=72)
          plt.close()
          assert out.exists(), "Figure was not created"
          print(f"Created {out} ({out.stat().st_size} bytes)")
          SCRIPT

      - name: Run figure test
        run: python test_figure_regression.py

      - name: Optional pixel diff (if baseline exists)
        run: |
          if [ -f .github/baselines/figure_test_output.png ]; then
            python -c '
          from PIL import Image
          import imagehash
          curr = imagehash.average_hash(Image.open("figure_test_output.png"))
          base = imagehash.average_hash(Image.open(".github/baselines/figure_test_output.png"))
          diff = curr - base
          print(f"Hash difference: {diff}")
          if diff > 5:
              print("::warning::Figure differs significantly from baseline")
          '
          else
            echo "No baseline found, skipping pixel diff"
          fi
        continue-on-error: true
