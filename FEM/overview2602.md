手法の全体像 — ビッグピクチャー
1. 何をやっているのか？（一言で）

┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│   "口腔内バイオフィルムの菌間相互作用を                           │
│    ベイズ推定で定量化する"                                        │
│                                                                 │
│   実験データ（時系列）→ パラメータ推定 → 菌の関係ネットワーク      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
2. 全体フロー（大枠）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  【入力】              【モデル】              【推定】       【出力】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  実験データ           ODEモデル              TMCMC           パラメータ
  ──────────         ──────────           ──────────        ─────────
  5菌種の              菌の成長・            事前分布          相互作用行列
  体積分率              相互作用を            → 事後分布         A[i,j]
  (6時点)              微分方程式で           への漸進的          (20パラメータ)
                      表現                  サンプリング
  📊 [t×5 配列]       🧬 dφ/dt = f(θ)       🎲 TMCMC          📈 MAP推定値
                                                              + 信頼区間
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
3. 入力データの構造

実験条件（4種類）
  ├── Commensal × Static   （健常 × 静的環境）
  ├── Commensal × HOBIC    （健常 × 高酸素）
  ├── Dysbiotic × Static   （病的 × 静的環境）
  └── Dysbiotic × HOBIC    （病的 × 高酸素）  ← 現在の主対象

データ形式：
  時刻 [日] : 1    3    6    10   15   21
              ↓    ↓    ↓    ↓    ↓    ↓
  So  (S.oralis)   [φ₀, φ₁, φ₂, φ₃, φ₄, φ₅]
  An  (A.naes)     [φ₀, φ₁, φ₂, φ₃, φ₄, φ₅]
  Vd  (V.dispar)   [φ₀, φ₁, φ₂, φ₃, φ₄, φ₅]
  Fn  (F.nucleatum)[φ₀, φ₁, φ₂, φ₃, φ₄, φ₅]
  Pg  (P.gingiv.)  [φ₀, φ₁, φ₂, φ₃, φ₄, φ₅]

  → 形状: [6時点 × 5菌種]  実数値 (体積分率 0～1)
  → 制約: Σ φᵢ = 1 (常に体積保存)
4. 生物モデル（ODEの直感）

  So ──→ An          ← 菌種間の「助け合い・競争」を行列Aで表現
   ↑      |
   |      ↓
  Vd ──→ Fn ──→ Pg  ← Fnがゲートキーパー（Hill関数）
   ↑             ↑
   └─────────────┘

  相互作用行列 A [5×5] ← これが「推定したいもの」
  ┌                      ┐
  │ a₁₁  a₁₂  a₁₃  a₁₄  a₁₅ │  ← Soへの影響
  │ a₂₁  a₂₂  a₂₃  a₂₄  a₂₅ │  ← Anへの影響
  │  0    0   a₃₃  a₃₄  a₃₅ │  ← Vdへの影響
  │  0    0    0   a₄₄  a₄₅ │  ← Fnへの影響
  │  0    0    0    0   a₅₅ │  ← Pgへの影響
  └                      ┘
  ※ 0の部分は生物学的知見でロック

  プラス：各菌の viability (活性度) ψᵢ, 減衰率 bᵢ も推定 → 計20パラメータ
5. TMCMC アルゴリズムの直感

  アイデア：「事前分布から事後分布に"じわじわ"移行する」

  β = 0                    β = 0.5                   β = 1
  (事前分布)               (中間)                   (事後分布)
  ───────────           ───────────              ───────────
  広く散らばった           データに引き寄せ          データに合った
  粒子群                  られてきた                絞り込まれた分布
  .....*.*...*           ...*..**..*               ..****..*
  .*.*.......*           ..**.*...**                ..*****..
  .*...*.*...            ..*****...*               ...*****..

  Stage 1 → 2 → 3 → ... → N (今は8ステージ)

  各ステージで：
  ① βを決定（ESS≒50%になるよう自動調整）
  ② 重み付きリサンプリング
  ③ MCMC変異（150粒子を並列評価）
  ④ 3ステージごとに線形化点を更新（ROM精度向上）
6. 計算の仕組み（速度の秘密）

  パラメータθ一つにつき → ODEを数値積分 → 尤度計算
                              ↑
              これが重い！ → 2つの工夫

  ┌─────────────────────┐    ┌──────────────────────────────┐
  │   Numba JIT         │    │   TSM-ROM (縮約モデル)         │
  │   (高速化)           │    │   (近似だが超高速)             │
  │                     │    │                              │
  │  Pythonコードを      │    │  テイラー展開で線形近似          │
  │  機械語にコンパイル   │    │  → Full ODEの1/10の時間        │
  │  → 2-3倍高速        │    │  → 3ステージごとに精度確認      │
  └─────────────────────┘    └──────────────────────────────┘
                    +
  ┌─────────────────────────────────┐
  │   並列評価 (ProcessPoolExecutor) │
  │   150粒子を並列処理 → 4-8倍高速  │
  └─────────────────────────────────┘
7. 出力の全体像

  _runs/Dysbiotic_HOBIC_20260218_XXXX/
  │
  ├── config.json              ← 実験設定の記録
  ├── posterior_samples.npy    ← 事後サンプル [粒子×パラメータ]
  ├── metrics.json             ← RMSE・logL・収束指標
  │
  ├── parameter_summary.csv    ← MAP推定値・平均・95%CI
  │   例: a35 (Vd→Pg) = 3.56 [2.1, 4.8]
  │       a45 (Fn→Pg) = 2.41 [1.2, 3.6]
  │
  ├── diagnostics_tables/
  │   ├── beta_schedule.csv    ← βの進行
  │   ├── acceptance_rate.csv  ← MCMCの受理率
  │   └── stage_summary.csv    ← ESS・Rhat
  │
  └── figures/
      ├── posterior_*.png      ← 事後分布（コーナープロット）
      ├── fit_with_data.png    ← モデルvs実験データ
      └── convergence.png      ← 収束診断
8. なぜこの手法？（ポジショニング）

                     不確実性の定量化
                           ↑
                    TMCMC (今ここ)
                    ┌──────────────┐
                    │ 事後分布全体  │
                    │ MAP + CI付き  │
                    └──────────────┘
                           |
         ┌─────────────────┼─────────────────┐
         ↓                 ↓                 ↓
  最適化のみ           MCMC単体          神経ODE等
  (MAP点のみ)      (βスケジュール無し)   (データ大量必要)
  速いが信頼区間なし   多峰分布で失敗しやすい   生物解釈難しい

  → TMCMCは「少ないデータ・多峰性・高次元」に強いベイズ法
9. 一枚絵まとめ

╔══════════════════════════════════════════════════════════════╗
║                                                              ║
║  実験         モデル          推定            知見            ║
║                                                              ║
║  [菌の量]  →  [ODE方程式]  →  [TMCMC]   →  [相互作用強度]   ║
║  [6時点]      [20パラメータ]   [8ステージ]    [MAP + 95%CI]   ║
║  [5菌種]      [Aij行列]       [150粒子]      [RMSE評価]      ║
║              [Hill関数]      [並列評価]      [収束診断]       ║
║                                                              ║
║  Dysbiotic  →  φᵢ(t;θ)  →  p(θ|D)  →  Pg改善: 0.43→0.10  ║
║                                                              ║
╚══════════════════════════════════════════════════════════════╝
ポイントのまとめ（3行）:

何を: 5菌種の相互作用行列（20パラメータ）をベイズ推定
どうやって: ODEモデル × TMCMC（漸進的温度スケジュール）× 並列・ROM高速化
なぜうまくいく: 少ない実験データ・非線形・高次元に強い手法の組み合わせ
