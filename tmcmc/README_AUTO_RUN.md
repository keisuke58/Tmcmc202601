# 自動実行プログラムの使い方

## 概要

`auto_run_5000_after_1000.py` は、1000パーティクル実行が完了したら自動的に5000パーティクル実行を開始するプログラムです。

---

## 基本的な使い方

### 方法1: 反復実行モード（推奨）✨ 新機能

**目標精度に達するまで自動的に繰り返し実行**

```cmd
cd "C:\Users\nishioka\Neuer Ordner\tmcmc_docs\tmcmc"
python auto_run_5000_after_1000.py --wait-for-run-id m1_1000_20260118_083726 --iterative
```

**特徴**:
- 目標精度（ESS_min ≥ 300, RMSE ≤ 0.02）に達するまで自動的に繰り返し実行
- 各反復で設定を自動調整（パーティクル数、ステージ数などを増加）
- 目標達成時に自動停止

### 方法2: 最新の実行を待つ

```cmd
python auto_run_5000_after_1000.py
```

最新の実行IDを自動検出して、完了を待ちます。

### 方法3: 特定の実行IDを指定

```cmd
python auto_run_5000_after_1000.py --wait-for-run-id m1_1000_20260118_083726
```

### 方法4: レビューをスキップして即座に実行

```cmd
python auto_run_5000_after_1000.py --wait-for-run-id m1_1000_20260118_083726 --skip-review
```

---

## オプション

### `--wait-for-run-id <run_id>`
待つ実行IDを指定します。

### `--wait-for-latest`
最新の実行を待ちます（デフォルト動作）。

### `--check-interval <秒>`
完了チェックの間隔を指定します（デフォルト: 60秒）。

例: 30秒ごとにチェック
```cmd
python auto_run_5000_after_1000.py --check-interval 30
```

### `--skip-review`
1000パーティクル実行結果のレビューをスキップして、即座に5000パーティクル実行を開始します。

### `--runs-root <パス>`
実行ディレクトリのルートを指定します（デフォルト: `tmcmc/_runs`）。

### `--iterative` ✨ 新機能
**反復実行モード**: 目標精度に達するまで自動的に繰り返し実行します。

### `--max-iterations <回数>`
最大反復回数を指定します（デフォルト: 3）。`--iterative`と併用します。

### `--target-ess-min <値>`
目標ESS_minを指定します（デフォルト: 300.0）。`--iterative`と併用します。

### `--target-rmse-max <値>`
目標RMSE最大値を指定します（デフォルト: 0.02）。`--iterative`と併用します。

### `--target-status <ステータス>`
目標ステータスを指定します（デフォルト: PASS）。`--iterative`と併用します。

---

## 動作の流れ

1. **実行完了の待機**
   - 指定された実行ID（または最新の実行）の完了を待ちます
   - `REPORT.md`が生成されるまで監視します
   - 定期的に進捗を表示します

2. **結果のレビュー**（`--skip-review`がない場合）
   - 1000パーティクル実行の結果をレビューします
   - ESS_min、RMSE、収束状態などを確認します
   - 問題がある場合は警告を表示します

3. **5000パーティクル実行の開始**
   - レビューが問題なければ、5000パーティクル実行を開始します
   - 実行IDとログファイルのパスを表示します

---

## 5000パーティクル実行の設定

自動実行される5000パーティクル実行の設定：

- **パーティクル数**: 5000
- **ステージ数**: 30
- **Mutation steps**: 5
- **チェーン数**: 1
- **max_delta_beta**: 0.05
- **target_ess_ratio**: 0.5
- **seed**: 42

---

## 実行例

### 例1: 反復実行モード（推奨）✨ 完璧な精度まで自動実行

```cmd
cd "C:\Users\nishioka\Neuer Ordner\tmcmc_docs\tmcmc"
python auto_run_5000_after_1000.py --wait-for-run-id m1_1000_20260118_083726 --iterative
```

**動作**:
1. 1000パーティクル実行の完了を待つ
2. 自動レビューを実行
3. 目標精度（ESS_min ≥ 300, RMSE ≤ 0.02）をチェック
4. 未達成の場合、設定を自動調整して再実行
5. 目標達成まで繰り返し（最大3回）

### 例2: カスタム目標で反復実行

```cmd
python auto_run_5000_after_1000.py \
  --wait-for-run-id m1_1000_20260118_083726 \
  --iterative \
  --target-ess-min 500 \
  --target-rmse-max 0.01 \
  --max-iterations 5
```

### 例3: 通常モード（1回だけ実行）

```cmd
python auto_run_5000_after_1000.py --wait-for-run-id m1_1000_20260118_083726
```

### 例4: 30秒ごとにチェック（より頻繁に進捗確認）

```cmd
python auto_run_5000_after_1000.py --wait-for-run-id m1_1000_20260118_083726 --check-interval 30
```

### 例5: レビューをスキップして即座に実行

```cmd
python auto_run_5000_after_1000.py --wait-for-run-id m1_1000_20260118_083726 --skip-review
```

---

## 実行状況の確認

5000パーティクル実行が開始されたら、以下のコマンドで進捗を確認できます：

```cmd
cd "C:\Users\nishioka\Neuer Ordner\tmcmc_docs"
python tmcmc\check_running.py
```

---

## 注意事項

1. **実行時間**: 1000パーティクル実行は約3-6時間かかる可能性があります
2. **5000パーティクル実行**: 約10-20時間かかる可能性があります
3. **リソース**: メモリとCPUを大量に使用します
4. **中断**: Ctrl+Cで中断できますが、途中結果は保存されません

---

## トラブルシューティング

### 実行が見つからない
```
❌ 実行中の実行が見つかりません
```
→ 実行IDを確認するか、`--wait-for-run-id`で明示的に指定してください

### 完了が検知されない
→ `--check-interval`を短くして、より頻繁にチェックしてください

### レビューで問題が検出された場合
→ 問題を確認してから、手動で5000パーティクル実行を開始してください

---

**作成日**: 2026-01-18

