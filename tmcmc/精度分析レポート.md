# 精度が出ない原因分析レポート

## 1. 現状の問題点

### 1.1 ESS (Effective Sample Size) が低い
- **失敗例**: ESS_min = 5.51 < 100 (FAIL)
- **警告例**: ESS_min = 141 < 300 (WARN)
- **目標**: ESS_min ≥ 300 (推奨), ≥ 100 (最低)

**影響**:
- ESSが低い = サンプルの有効性が低い = 事後分布の推定精度が低い
- パラメータ推定の信頼性が低下
- 収束判定が失敗

### 1.2 収束していない
- **現状**: converged_chains = 0/1 (全く収束していない)
- **目標**: converged_chains ≥ 1/1

**影響**:
- パラメータ推定が不安定
- MAP推定の信頼性が低い

### 1.3 パラメータ推定誤差が大きい
- **現状**: total_map_error = 3.66
- **RMSE**: 0.07-0.15 (許容範囲だが改善の余地)

## 2. 根本原因分析

### 2.1 ハイパラメータ設定の問題

#### 現在の設定 (実行中)
```python
n_particles = 300      # ❌ 少なすぎる
n_stages = 20          # ❌ 少なすぎる
target_ess_ratio = 0.5 # ✅ 適切
max_delta_beta = 0.2   # ⚠️ 大きすぎる可能性
```

#### 推奨設定 (デフォルト)
```python
n_particles = 2000     # ✅ 推奨
n_stages = 30          # ✅ 推奨
target_ess_ratio = 0.5 # ✅ 適切
max_delta_beta = 0.2   # ⚠️ 調整の余地あり
```

#### 本番推奨設定 (高精度)
```python
n_particles = 2000-5000  # ✅ 精度重視なら5000
n_stages = 30-50         # ✅ β=1.0到達を確実に
n_mutation_steps = 5-10  # ✅ 粒子相関を減らす
max_delta_beta = 0.05    # ✅ より保守的 (0.2→0.05)
```

### 2.2 β (tempering) スケジュールの問題

**問題点**:
- `max_delta_beta = 0.2` が大きすぎる可能性
- βが急激に変化すると、重みの崩壊 (weight collapse) が発生
- ESSが急激に低下し、サンプル品質が悪化

**推奨**:
- `max_delta_beta = 0.05` に削減 (より保守的)
- `min_delta_beta = 0.02` は維持 (進行保証)

### 2.3 粒子数不足の問題

**問題点**:
- `n_particles = 300` では、ESS_min = 141 が限界
- 目標ESS = 300 を達成するには、最低でも `n_particles = 600` 必要
- 推奨は `n_particles = 2000` 以上

**計算**:
- target_ess_ratio = 0.5 の場合
- 目標ESS = 0.5 × n_particles
- n_particles = 300 → 目標ESS = 150 (実際141)
- n_particles = 2000 → 目標ESS = 1000 (余裕あり)

### 2.4 ステージ数不足の問題

**問題点**:
- `n_stages = 20` では、β=1.0 に到達する前に終了する可能性
- 特に `max_delta_beta = 0.05` の場合、最低20ステージ必要
- 推奨は `n_stages = 30-50`

**計算**:
- max_delta_beta = 0.2 の場合: 最低5ステージでβ=1.0
- max_delta_beta = 0.05 の場合: 最低20ステージでβ=1.0
- 安全のため、余裕を持って30-50ステージ推奨

## 3. 課題の優先順位

### 🔴 最優先 (Critical)
1. **n_particles を増やす**: 300 → 2000以上
2. **n_stages を増やす**: 20 → 30-50
3. **max_delta_beta を減らす**: 0.2 → 0.05

### 🟡 重要 (Important)
4. **n_mutation_steps を増やす**: 3-5 → 5-10 (粒子相関を減らす)
5. **n_chains を増やす**: 1 → 3-5 (収束診断のため)

### 🟢 推奨 (Recommended)
6. **target_ess_ratio の調整**: 0.5 は維持 (適切)
7. **linearization更新間隔**: 3 は維持 (適切)

## 4. 推奨される修正

### 4.1 即座に適用すべき設定

```python
# sweep_m1.sh のデフォルト設定を変更
NP_LIST="${NP_LIST:-2000 3000 5000}"  # 300, 500, 1000 → 2000, 3000, 5000
N_STAGES="${N_STAGES:-30}"            # 20 → 30
```

### 4.2 config.py のデフォルト設定

```python
@dataclass(frozen=True)
class TMCMCDefaults:
    n_particles: int = 2000        # 2000 (現状維持)
    n_stages: int = 30            # 30 (現状維持)
    target_ess_ratio: float = 0.5 # 0.5 (現状維持)
    min_delta_beta: float = 0.02  # 0.02 (現状維持)
    max_delta_beta: float = 0.05  # 0.2 → 0.05 に変更推奨
    n_mutation_steps: int = 5     # 5 (現状維持)
```

### 4.3 本番実行時の推奨設定

```bash
python tmcmc/run_pipeline.py \
  --mode paper \
  --n-particles 2000 \
  --n-stages 30 \
  --n-mutation-steps 5 \
  --n-chains 3 \
  --target-ess-ratio 0.5 \
  --max-delta-beta 0.05
```

## 5. 期待される改善効果

### 5.1 ESS の改善
- **現状**: ESS_min = 141 (WARN)
- **期待**: ESS_min = 1000+ (PASS)
- **効果**: サンプル品質の大幅向上

### 5.2 収束の改善
- **現状**: converged_chains = 0/1
- **期待**: converged_chains = 3/3 (n_chains=3の場合)
- **効果**: 推定の信頼性向上

### 5.3 精度の改善
- **現状**: total_map_error = 3.66
- **期待**: total_map_error < 1.0
- **効果**: パラメータ推定精度の向上

## 6. 実装チェックリスト

- [ ] `sweep_m1.sh` の `NP_LIST` を更新
- [ ] `sweep_m1.sh` の `N_STAGES` を更新
- [ ] `config.py` の `max_delta_beta` を 0.05 に変更
- [ ] 本番実行時のデフォルト設定を確認
- [ ] テスト実行で ESS_min ≥ 300 を確認

## 7. 補足: なぜ精度が出ないのか

### 7.1 統計的な理由
- **ESSが低い** = 有効サンプル数が少ない = 事後分布の推定が不正確
- **収束していない** = MCMCチェーンが定常分布に到達していない
- **βが急激に変化** = 重みの崩壊 = サンプル品質の悪化

### 7.2 計算リソースの理由
- **粒子数が少ない** = 探索空間のカバーが不十分
- **ステージ数が少ない** = β=1.0 に到達する前に終了
- **mutation steps が少ない** = 粒子間の相関が高い

### 7.3 アルゴリズム設定の理由
- **max_delta_beta が大きい** = βの急激な変化 = 重みの崩壊
- **n_chains が1** = 収束診断ができない = 収束の確認ができない

---

**作成日**: 2026-01-17
**分析対象**: sweep_m1_20260116_093734 および関連実行結果
