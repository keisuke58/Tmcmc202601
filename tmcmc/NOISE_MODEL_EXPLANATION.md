# ノイズモデルの説明 (Noise Model Explanation)

## 現在の実装: sigma_obs = 0.01 の適用方法

### 1. データ生成時のノイズ適用 (`main/case2_main.py` 454行目)

```python
data[:, i] = phibar[idx_sparse, i] + rng.standard_normal(exp_config.n_data) * exp_config.sigma_obs
```

**適用方法:**
- `phibar[idx_sparse, i]`: 真の値（TSMシミュレーションから計算された φ̄ = φ × ψ）
- `rng.standard_normal(exp_config.n_data)`: 標準正規分布 N(0, 1) から生成された乱数
- `* exp_config.sigma_obs`: sigma_obs = 0.01 でスケーリング

**結果:**
```
data = phibar + N(0, sigma_obs²)
     = phibar + N(0, 0.01²)
```

つまり、各観測データポイントは:
- **平均**: `phibar` (真の値)
- **分散**: `sigma_obs² = 0.01² = 0.0001`
- **標準偏差**: `sigma_obs = 0.01`

### 2. なぜ常にオフセット/誤差があるのか？

**これは正常な動作です！**

1. **ランダムノイズの性質**:
   - ノイズは平均0の正規分布から生成されます
   - しかし、個々のサンプルは必ずしも0ではありません
   - 各データポイントは `phibar ± (ランダムな値)` になります

2. **統計的な期待値**:
   - 多くのデータポイントを平均すると、ノイズの平均は0に近づきます
   - しかし、個々のデータポイントは常に真の値からずれます

3. **例**:
   ```
   真の値 phibar = 0.5 の場合:
   - データポイント1: 0.5 + 0.008 = 0.508  (ノイズ: +0.008)
   - データポイント2: 0.5 - 0.012 = 0.488  (ノイズ: -0.012)
   - データポイント3: 0.5 + 0.003 = 0.503  (ノイズ: +0.003)
   ```
   各ポイントは真の値からずれていますが、平均すると0.5に近づきます。

### 3. 尤度計算でのノイズモデル

尤度計算では、より複雑なノイズモデルが使用されます:

```
var_total = sig + sigma_obs²
```

ここで:
- `sig`: TSMシミュレーションの不確実性（パラメータの不確実性から伝播）
- `sigma_obs²`: 観測ノイズの分散 (0.01² = 0.0001)

**重要な点:**
- **データ生成**: 観測ノイズのみを追加 (`sigma_obs`)
- **尤度計算**: TSM不確実性 + 観測ノイズの両方を考慮 (`sig + sigma_obs²`)

これは正しい実装です。データ生成時には観測ノイズのみを追加し、ベイジアン推論時にはTSMの不確実性も考慮します。

### 4. ノイズの統計的特性

`sigma_obs = 0.01` の場合:

- **68%のデータポイント**は真の値から ±0.01 以内
- **95%のデータポイント**は真の値から ±0.02 以内
- **99.7%のデータポイント**は真の値から ±0.03 以内

### 5. ノイズを変更する方法

```bash
# より小さいノイズ (10倍小さい)
python -m main.case2_main --mode debug --sigma-obs 0.001

# より大きいノイズ (2倍大きい)
python -m main.case2_main --mode debug --sigma-obs 0.02

# ノイズなし（トレーニングデータ用）
python -m main.case2_main --mode debug --no-noise
```

### 6. 確認方法

`test_no_noise.py` を実行すると、ノイズあり/なしの比較ができます:

```bash
python test_no_noise.py
```

このスクリプトは:
- ノイズありデータの残差の標準偏差を表示
- ノイズなしデータが `phibar` と完全に一致することを確認
- 比較プロットを生成

### まとめ

- **sigma_obs = 0.01** は観測ノイズの標準偏差です
- データ生成時: `data = phibar + N(0, 0.01²)`
- 個々のデータポイントは常に真の値からずれます（これが正常です）
- 多くのデータポイントを平均すると、ノイズの影響は相殺されます
- 尤度計算では、TSM不確実性と観測ノイズの両方が考慮されます
