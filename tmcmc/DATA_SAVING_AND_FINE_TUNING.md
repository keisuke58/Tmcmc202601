# データ保存と設定の微調整について

**作成日**: 2026-01-18

---

## 💾 データ保存について

### 毎回必ず保存されるデータ

各実行（1000パーティクル、5000パーティクルなど）が完了すると、**必ず以下のデータが保存されます**：

#### 1. 必須ファイル（自動保存）

- ✅ **`REPORT.md`** - 実行結果のサマリーレポート
  - ステータス（PASS/WARN/FAIL）
  - メトリクス（ESS_min, RMSE, MAE, max_abs）
  - 診断結果
  - 生成された図のリスト

- ✅ **`metrics.json`** - 数値メトリクス（JSON形式）
  - 実行時間
  - 収束状態
  - エラー情報
  - 健康状態（likelihood health）

- ✅ **`results_MAP_linearization.npz`** - 数値結果（NumPy形式）
  - theta_true（真のパラメータ）
  - theta_MAP_full（MAP推定値）
  - samples_M1, samples_M2, samples_M3（サンプル）
  - logL_M1, logL_M2, logL_M3（対数尤度）
  - converged_M1, converged_M2, converged_M3（収束フラグ）
  - diagnostics_M1, diagnostics_M2, diagnostics_M3（診断結果）

- ✅ **`config.json`** - 実行設定
  - パーティクル数、ステージ数、Mutation steps
  - その他のTMCMC設定

#### 2. レビューファイル（自動生成）

- ✅ **`REVIEW_1000_particles.md`** - 自動レビューレポート
  - 実行サマリー
  - 良好な点
  - 問題点
  - 詳細メトリクス
  - 改善提案
  - 5000パーティクル実行への推奨

#### 3. 可視化ファイル（自動生成）

- ✅ **`figures/`** ディレクトリ
  - `TSM_simulation_M1_with_data.png`
  - `TSM_simulation_M1_MAP_fit_with_data.png`
  - `TSM_simulation_M1_MEAN_fit_with_data.png`
  - `posterior_M1.png`
  - `FIGURES_MANIFEST.json`（図のマニフェスト）

#### 4. 診断テーブル（自動生成）

- ✅ **`diagnostics_tables/`** ディレクトリ
  - `M1_acceptance_rate.csv`
  - `M1_beta_schedule.csv`
  - `M1_rom_error.csv`
  - `M1_stage_summary.csv`
  - `M1_theta0_history.csv`

#### 5. 設定変更履歴（反復実行時）

- ✅ **`config_history.json`** - 設定変更の履歴
  - 反復回数
  - 前回の設定
  - 次の設定
  - レビューサマリー
  - 調整理由

---

## 🔧 設定の微調整とは

### 概要

**設定の微調整**は、現在の実行結果を分析して、次の実行の設定を**自動的に最適化**する機能です。

### 微調整のロジック

#### 1. 基本設定の段階的増加

反復回数に応じて、基本設定を段階的に増やします：

| 反復回数 | パーティクル数 | ステージ数 | Mutation steps | チェーン数 |
|---------|--------------|-----------|----------------|-----------|
| 1回目   | 5000         | 30        | 5              | 1         |
| 2回目   | 5000         | 40        | 7              | 1         |
| 3回目以降 | 8000       | 50        | 10             | 3         |

#### 2. ESS_minに基づく適応的調整

**ESS_minが低い場合** → パーティクル数とステージ数を増やす

| ESS_min | 調整内容 |
|---------|---------|
| < 100   | パーティクル数 → 10000、ステージ数 → 50 |
| < 200   | パーティクル数 → 8000、ステージ数 → 40 |
| < 250   | ステージ数 → 35 |

**理由**: ESS_minが低い = サンプル品質が低い = より多くのサンプルとより滑らかなβスケジュールが必要

#### 3. RMSEに基づく適応的調整

**RMSEが高い場合** → ステージ数とMutation stepsを増やす

| RMSE    | 調整内容 |
|---------|---------|
| > 0.05  | ステージ数 → 50、Mutation steps → 10 |
| > 0.03  | ステージ数 → 40、Mutation steps → 7 |
| > 0.025 | ステージ数 → 35 |

**理由**: RMSEが高い = 推定精度が低い = より多くのステージとより良い混合が必要

#### 4. 受容率に基づく適応的調整

**受容率が不適切な場合** → Mutation stepsを調整

| 受容率 | 調整内容 |
|--------|---------|
| < 0.2  | Mutation steps → -2（より保守的に） |
| > 0.9  | Mutation steps → +3（より積極的に探索） |

**理由**: 
- 受容率が低すぎる = 提案が大きすぎる = Mutation stepsを減らす
- 受容率が高すぎる = 探索が不十分 = Mutation stepsを増やす

#### 5. 収束状態に基づく適応的調整

**収束していない場合** → チェーン数とステージ数を増やす

| 状態 | 調整内容 |
|------|---------|
| 未収束 | チェーン数 → 3、ステージ数 → 40 |

**理由**: 収束していない = より多くのチェーンとより多くのステージが必要

---

## 🎯 完璧になるまでのプロセス

### ステップ1: 1000パーティクル実行

- **目的**: 初期探索と問題の検出
- **設定**: 1000パーティクル、20ステージ、Mutation steps 5
- **完了後**: 自動レビュー → データ保存

### ステップ2: 5000パーティクル実行（反復1）

- **目的**: 精度の向上
- **設定**: 5000パーティクル、30ステージ、Mutation steps 5
- **完了後**: 
  - 自動レビュー
  - 目標精度チェック
  - データ保存
  - 設定変更履歴の保存

### ステップ3: 目標精度チェック

**目標基準**:
- ESS_min ≥ 300
- RMSE ≤ 0.02
- ステータス = PASS
- 収束 = True

**判定**:
- ✅ **達成** → 🎉 完了
- ❌ **未達成** → ステップ4へ

### ステップ4: 設定の微調整と再実行

**微調整の実行**:
1. 現在の結果を分析
2. 問題点を特定（ESS_min低い、RMSE高いなど）
3. 設定を自動調整
4. 調整理由を記録

**再実行**:
- 調整された設定で再実行
- ステップ3に戻る

### ステップ5: 最大反復回数に達した場合

- 最大反復回数（デフォルト: 3回）に達した場合、実行を終了
- 最終結果を保存
- 目標未達成の場合は警告を表示

---

## 📊 データ保存の確認方法

### 各実行ディレクトリで確認

```cmd
cd "C:\Users\nishioka\Neuer Ordner\tmcmc_docs\tmcmc\_runs\<run_id>"
dir
```

**確認すべきファイル**:
- `REPORT.md` - 実行レポート
- `metrics.json` - メトリクス
- `results_MAP_linearization.npz` - 数値結果
- `REVIEW_1000_particles.md` - レビューレポート（自動生成）
- `config_history.json` - 設定変更履歴（反復実行時）
- `figures/` - 可視化結果
- `diagnostics_tables/` - 診断テーブル

---

## 🔍 設定の微調整の例

### 例1: ESS_minが低い場合

**現在の結果**:
- ESS_min = 150
- RMSE = 0.025

**微調整**:
```
🔧 微調整: ESS_min (150.0) < 200 → パーティクル数8000, ステージ数40
```

**次の設定**:
- パーティクル数: 5000 → 8000
- ステージ数: 30 → 40

### 例2: RMSEが高い場合

**現在の結果**:
- ESS_min = 280
- RMSE = 0.035

**微調整**:
```
🔧 微調整: RMSE (0.035000) > 0.03 → ステージ数40, Mutation steps 7
```

**次の設定**:
- ステージ数: 30 → 40
- Mutation steps: 5 → 7

### 例3: 複数の問題がある場合

**現在の結果**:
- ESS_min = 120
- RMSE = 0.045
- 受容率 = 0.15

**微調整**:
```
🔧 微調整: ESS_min (120.0) < 200 → パーティクル数8000, ステージ数40
🔧 微調整: RMSE (0.045000) > 0.03 → ステージ数40, Mutation steps 7
🔧 微調整: 受容率 (0.150) < 0.2 → Mutation steps 5
```

**次の設定**:
- パーティクル数: 5000 → 8000
- ステージ数: 30 → 40
- Mutation steps: 5 → 5（受容率が低いため増やさない）

---

## ✅ 完璧になるまでの流れ

```
1000パーティクル実行
    ↓
自動レビュー + データ保存
    ↓
5000パーティクル実行（反復1）
    ↓
自動レビュー + データ保存 + 目標精度チェック
    ↓
未達成 → 設定の微調整
    ↓
5000パーティクル実行（反復2、設定調整済み）
    ↓
自動レビュー + データ保存 + 目標精度チェック
    ↓
未達成 → 設定の微調整
    ↓
5000パーティクル実行（反復3、設定調整済み）
    ↓
自動レビュー + データ保存 + 目標精度チェック
    ↓
✅ 目標達成 → 🎉 完了
```

---

## 📋 データ保存の保証

### 自動保存の仕組み

1. **実行完了の検知**: `REPORT.md`の生成を確認
2. **データ保存の確認**: 各実行ディレクトリで必須ファイルの存在を確認
3. **レビューレポートの保存**: 自動レビュー結果を`REVIEW_1000_particles.md`に保存
4. **設定変更履歴の保存**: 反復実行時、`config_history.json`に保存

### 保存されるタイミング

- ✅ 実行完了直後（`REPORT.md`生成時）
- ✅ 自動レビュー実行時（`REVIEW_1000_particles.md`）
- ✅ 設定変更時（`config_history.json`）
- ✅ 各反復の完了時（すべてのデータ）

---

**まとめ**: 毎回必ず丁寧にデータを保存し、設定の微調整により完璧な精度を目指します。


