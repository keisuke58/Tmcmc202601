# M3モデル問題 - 最終診断結果

## 確認済み事項

### ✅ M3のデータ生成元
**M3モデルから独立に生成されている（M1からではない）**

- 実行結果のデータと再生成データが完全一致
- インデックス、時間配列も一致

### ⚠️ 時間スケールの違い

| モデル | 時間範囲 | ステップ数 | 比率 |
|--------|---------|-----------|------|
| M1     | 0.025   | 2501      | 1.0  |
| M3     | 0.075   | 751       | 3.0  |

**M1とM3で異なる時間スケールを使用している**

## テスト結果

### テストA: 同じt_arr上で比較

**結果: [NO] 同じt_arrでもズレは変わらない → 時間軸以外が主因**

- M3 (M3's t_arr) RMSE: 0.00978241
- M3 (M1's t_arr) RMSE: 0.00947791
- 改善率: 3.1%（微少）

**結論**: 時間スケールの違いは主要因ではない

### テストB: 尤度の重み正規化

**結果: Species間の差は中程度**

- 標準尤度の比率 (max/min): 1.14（それほど極端ではない）
- Species 3の残差RMSEが小さい（0.0057 vs 他は0.0109程度）
- Species 3が標準尤度の27.5%を占める（最大だが、支配的ではない）

**結論**: species重みの問題は中程度。主要因ではない可能性が高い

## 修正された結論

### 以前の結論（修正前）
> 時間正規化の不整合は主要因ではない可能性が高い

### より正確な結論（修正後）

1. **"正規化定義のミス"ではない**
   - 正規化の実装は正しい
   - 各モデル内で一貫している

2. **しかし、時間スケール差 (0.025 vs 0.075) が適合性に影響しうる**
   - テストAの結果、同じt_arrでもズレは変わらない
   - **時間スケール差は主要因ではない**

3. **より可能性が高い原因**
   - **M3モデルの構造ミスマッチ**（結合項/パラメータ不足）
   - **校正に使ったデータ点が一部speciesのみ支配**（φ3, φ4が特に外れる）
   - **尤度設計の問題**（M3でのspecies間の重み付け）

## 次のステップ（優先順位順）

| 優先 | 作業 | 目的 | 状態 |
|------|------|------|------|
| 1 | テストB: species重み正規化 | "一部species支配"排除 | ✅ 完了 |
| 2 | M3モデル構造の確認 | 結合項/パラメータが適切か | 未実施 |
| 3 | Posterior predictive band | 論文と同じ評価 | 未実施 |
| 4 | 各speciesの残差分析 | φ3, φ4が特に外れる原因 | 未実施 |

## 重要な発見

### 時間スケールの問題
- **M1とM3で異なる時間スケール**を使用しているが、**これは主要因ではない**
- テストAで同じt_arrにしてもズレは変わらない

### データ生成
- **M3のデータはM3から生成されている**（M1からではない）
- データ生成自体は正しく実装されている

### 残差の特徴
- M3 (M3's t_arr) RMSE: 0.00978241
- M3 (M1's t_arr) RMSE: 0.00947791
- M1 (M1's t_arr) RMSE: 0.01061189

M3のRMSEはM1と同程度で、時間スケールを変えても大きく変わらない。

## 推奨される対策

1. **species重み正規化**
   - speciesごとに残差を `/(sigma_obs)` で正規化
   - または `/(std(data_species))` で正規化

2. **species別sigma_obs**
   - φ4だけ合わない等を吸収

3. **M3モデル構造の見直し**
   - 結合項が適切にモデル化されているか
   - パラメータ数が十分か
