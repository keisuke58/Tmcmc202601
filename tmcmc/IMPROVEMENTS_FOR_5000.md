# 5000パーティクル実行前の改善チェックリスト

**作成日**: 2026-01-18  
**目的**: 1000パーティクル実行完了後、5000パーティクル実行前に必ず改善すべき点

---

## 🔴 最優先改善項目（必須）

### 1. max_delta_beta の調整
**現状**: 0.2（大きすぎる）  
**推奨**: 0.05（より保守的）

**理由**:
- βが急激に変化すると、重みの崩壊（weight collapse）が発生
- ESSが急激に低下し、サンプル品質が悪化
- より滑らかなβスケジュールが必要

**修正箇所**:
- `config.py` のデフォルト値
- 実行時の `--max-delta-beta 0.05` オプション

---

### 2. n_stages の確認
**現状**: 20（1000パーティクル実行）  
**推奨**: 30-50（5000パーティクル実行）

**理由**:
- max_delta_beta = 0.05 の場合、最低20ステージ必要
- 安全のため、余裕を持って30-50ステージ推奨
- β=1.0到達を確実にする

**修正箇所**:
- 実行時の `--n-stages 30` オプション

---

### 3. n_mutation_steps の確認
**現状**: 5（1000パーティクル実行）  
**推奨**: 5-10（5000パーティクル実行）

**理由**:
- 粒子間の相関を減らす
- より良い混合を実現
- 5000パーティクルでは5-10ステップ推奨

**修正箇所**:
- 実行時の `--n-mutation-steps 5` オプション（現状維持でOK）

---

## 🟡 重要改善項目（推奨）

### 4. target_ess_ratio の確認
**現状**: 0.5  
**推奨**: 0.5（維持）

**理由**:
- 0.5は適切な値
- 変更不要

---

### 5. n_chains の検討
**現状**: 1  
**推奨**: 1-3（5000パーティクルでは1でも可）

**理由**:
- 収束診断のため複数チェーンが望ましい
- ただし、5000パーティクルでは1チェーンでも十分な場合がある
- 実行時間とのトレードオフ

**修正箇所**:
- 実行時の `--n-chains 1` オプション（現状維持でOK、必要に応じて3に変更）

---

## 🟢 推奨改善項目（任意）

### 6. linearization更新間隔の確認
**現状**: 3  
**推奨**: 3（維持）

**理由**:
- 3は適切な値
- 変更不要

---

### 7. linearization_threshold の確認
**現状**: 0.75  
**推奨**: 0.75（維持）

**理由**:
- 0.75は適切な値
- 変更不要

---

## 📋 1000パーティクル実行完了後の確認項目

### チェックリスト

- [ ] **ESS_min の確認**
  - 目標: ESS_min ≥ 100（最低）
  - 推奨: ESS_min ≥ 300（理想）
  - 1000パーティクルでESS_min < 100の場合、設定を見直す

- [ ] **収束の確認**
  - converged_chains = 1/1 を確認
  - 収束していない場合、n_stagesを増やす

- [ ] **MAP誤差の確認**
  - total_map_error < 1.0 を目標
  - 大きい場合、設定を見直す

- [ ] **受容率の確認**
  - accept_rate_mean: 0.5-0.7 が適切
  - 範囲外の場合、n_mutation_stepsを調整

- [ ] **βスケジュールの確認**
  - beta_final = 1.0 を確認
  - 到達していない場合、n_stagesを増やす

---

## 🔧 5000パーティクル実行時の推奨設定

### 基本設定
```bash
python tmcmc\run_pipeline.py \
  --mode debug \
  --models M1 \
  --n-particles 5000 \
  --n-stages 30 \
  --n-mutation-steps 5 \
  --n-chains 1 \
  --max-delta-beta 0.05 \
  --target-ess-ratio 0.5 \
  --seed 42
```

### 高精度設定（時間に余裕がある場合）
```bash
python tmcmc\run_pipeline.py \
  --mode debug \
  --models M1 \
  --n-particles 5000 \
  --n-stages 50 \
  --n-mutation-steps 10 \
  --n-chains 3 \
  --max-delta-beta 0.05 \
  --target-ess-ratio 0.5 \
  --seed 42
```

---

## 📊 期待される改善効果

### ESS の改善
- **100パーティクル**: ESS_min = 60.92 ❌
- **1000パーティクル**: ESS_min = 100-300（予想）⚠️
- **5000パーティクル**: ESS_min = 1000+（目標）✅

### 収束の改善
- **100パーティクル**: converged_chains = 1/1 ✅
- **1000パーティクル**: converged_chains = 1/1（予想）✅
- **5000パーティクル**: converged_chains = 1/1（目標）✅

### 精度の改善
- **100パーティクル**: RMSE = 0.03936 ✅
- **1000パーティクル**: RMSE < 0.03（予想）✅
- **5000パーティクル**: RMSE < 0.02（目標）✅

---

## ⚠️ 注意事項

1. **実行時間**: 5000パーティクルでは10-20時間かかる可能性
2. **リソース**: メモリとCPUを大量に使用
3. **中断**: Ctrl+Cで中断できるが、途中結果は保存されない
4. **改善の確認**: 1000パーティクルの結果を必ず確認してから5000パーティクルを実行

---

## 🔍 修正実装の優先順位

### 最優先（必須）
1. ✅ **max_delta_beta = 0.05** に設定
2. ✅ **n_stages = 30** に設定

### 重要（推奨）
3. ✅ **n_mutation_steps = 5** を確認（現状維持）
4. ✅ **target_ess_ratio = 0.5** を確認（現状維持）

### 任意
5. ⚠️ **n_chains = 3** を検討（時間に余裕がある場合）

---

**次のアクション**: 1000パーティクル実行完了後、このチェックリストに従って改善を実施


