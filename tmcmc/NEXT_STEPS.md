# M3モデル問題 - 次のステップ

## 診断結果サマリー

### ✅ 確認済み
1. **M3のデータ生成元**: M3モデルから独立に生成（M1からではない）
2. **時間正規化**: 正しく実装されている（主要因ではない）
3. **Species重み**: 中程度の差（主要因ではない）

### ⚠️ 発見された問題

1. **M3モデル構造**
   - M3は4つのspeciesをモデル化しているが、パラメータは4つだけ（結合項のみ）
   - M1とM2のパラメータは固定されている（階層的ベイズアプローチ）

2. **残差分析結果**
   - Species 3 (φ̄4)の残差RMSEが非常に小さい（0.0057 vs 他は0.0109程度）
   - Species 2 (φ̄3)の後半/前半比が1.43（後半で残差が大きくなる）
   - RMSE比率 (max/min): 1.92（Species間の差が大きい）

3. **構造ミスマッチの可能性**
   - データ生成時: theta_trueの全14パラメータを使用
   - M3推定時: M1/M2のMAP推定値 + M3パラメータのみ
   - **M1とM2の推定誤差がM3に伝播している可能性が高い**

## 次のステップ（優先順位順）

### 1. M1とM2の推定誤差を確認 ⭐ 最優先

**スクリプト**: `check_m1_m2_estimation_error.py`

**確認事項**:
- M1のMAP/Meanがtheta_true[0:5]にどれだけ近いか
- M2のMAP/Meanがtheta_true[5:10]にどれだけ近いか
- M3推定時に使用されるベース誤差がどれくらいか

**期待される結果**:
- M1/M2の推定誤差が大きい場合 → M3の適合性低下の原因
- M1/M2の推定誤差が小さい場合 → 他の原因を調査

### 2. M3データ生成と推定の一貫性を確認

**確認事項**:
- データ生成時にtheta_trueの全パラメータを使用しているか
- M3推定時にM1/M2の推定結果を正しく使用しているか
- theta_base_M3の構成が正しいか

**対策**:
- M3データ生成時にM1/M2の推定結果を使用する（一貫性の確保）
- または、M3推定時にtheta_trueを使用する（理想的なケース）

### 3. Posterior Predictive Check

**実装**:
- M3のposterior predictive bandを可視化
- データが予測区間内に収まっているか確認
- 論文と同じ評価方法で確認

### 4. Species別の詳細分析

**確認事項**:
- Species 2 (φ̄3)の後半で残差が大きくなる原因
- Species 3 (φ̄4)の残差が小さい理由
- 各speciesの残差パターン

## 推奨される対策

### 短期的対策

1. **M1とM2の推定精度を向上**
   - より多くのパーティクル（5000 → 10000）
   - より多くのステージ（50 → 100）
   - より多くのmutation steps

2. **M3推定時のベース値の改善**
   - M1/M2のMEANではなくMAPを使用（既に実装済み）
   - M1/M2の不確実性を考慮した統合

### 長期的対策

1. **階層的ベイズの完全実装**
   - M1/M2の不確実性をM3に伝播
   - 統合的な尤度設計

2. **モデル構造の見直し**
   - M3で推定するパラメータの範囲を拡大
   - または、M3データ生成時にM1/M2推定結果を使用

## 作成したスクリプト

1. `check_m3_data_source.py` - データ生成元の確認 ✅
2. `test_same_tarr_comparison.py` - テストA（同じt_arr上で比較）✅
3. `test_species_weight_normalization.py` - テストB（尤度重み正規化）✅
4. `analyze_m3_residuals.py` - 詳細残差分析 ✅
5. `check_m3_model_structure.py` - M3モデル構造の確認 ✅
6. `check_m1_m2_estimation_error.py` - M1/M2推定誤差の確認 ⭐ 実行中

## 重要な発見

### M3モデルの構造

- **M1**: 5パラメータ（species 0, 1の自己相互作用 + 成長率）
- **M2**: 5パラメータ（species 2, 3の自己相互作用 + 成長率）
- **M3**: 4パラメータ（species間相互作用のみ）

**問題点**:
- M3は4つのspeciesをモデル化しているが、パラメータは4つだけ
- M1とM2のパラメータが固定されているため、柔軟性が低い
- M1/M2の推定誤差がM3に伝播する可能性が高い

### 残差の特徴

- Species 3 (φ̄4)の残差が小さい → モデルがよく適合している
- Species 2 (φ̄3)の後半で残差が大きくなる → 時間依存の問題の可能性
- Species間の差が大きい → モデル構造の問題の可能性
