# M3モデル問題診断結果

## 診断結果サマリー

### ✅ 正常な項目

1. **no-noiseデータ生成**: phibarと完全一致（データ生成自体は正しい）
2. **時間正規化の定義**: 各モデル内で一貫している `(t_arr - t_min) / (t_max - t_min)`
3. **データポイント選択**: 期待される正規化時間（0.05間隔）と一致
4. **後半の乖離**: M1、M3ともに前半と後半で大きな差なし

### ⚠️ 発見された問題

1. **M1とM3でデータポイントインデックスが異なる**
   - M1: `[125, 250, 375, ..., 2500]` (2501ステップ)
   - M3: `[37, 75, 112, ..., 750]` (751ステップ)
   - **これは正常** - 異なるt_arr長さのため

2. **M1とM3で正規化時間が異なる**
   - Max difference: 0.7
   - **原因**: M1とM3でt_arrの長さが異なる（2501 vs 751）
   - 同じ正規化時間でも、異なる実時間に対応

## 重要な発見

### 時間配列の違い

- **M1**: t_arr shape (2501,), range [0.0, 0.025]
- **M3**: t_arr shape (751,), range [0.0, 0.075]

**M3の方が時間ステップが少なく、時間範囲が広い**

### 正規化時間の比較

| 項目 | M1 | M3 |
|------|----|----|
| 正規化時間範囲 | [0.0, 1.0] | [0.0, 1.0] |
| 観測点の正規化時間 | 0.05, 0.10, ..., 1.0 | 0.0493, 0.10, ..., 1.0 |
| 時間のずれ | 0.0 | 0.0007 (許容範囲) |

## 判定フロー結果

### 1. no-noiseでもズレる？
**→ NO** → ノイズ＋尤度設計の問題の可能性

### 2. M1はOKでM3だけNG？
**→ YES** → M3の結合項/パラメータ不足の可能性

### 3. 後半ほど乖離が拡大？
**→ NO** → 時間正規化の不整合は主要因ではない

## 推奨される次のステップ

1. **実際の実行結果の図を確認**
   - `_runs/20260122_162052_debug_seed42/figures/TSM_simulation_M3_with_data.png`
   - どのspeciesが特に外れているか確認

2. **M3モデルの構造確認**
   - 結合項（cross-terms）が適切にモデル化されているか
   - パラメータ数が十分か

3. **尤度計算の確認**
   - M3で使用されているデータポイントが正しいか
   - 各speciesの重みが適切か

4. **校正データ点の確認**
   - φ3, φ4が特に外れる場合、これらのspeciesのデータ点が適切に使われているか

## コード上の確認ポイント

### 時間正規化の実装
```python
# visualization/plot_manager.py
t_normalized = (t_arr - t_min) / (t_max - t_min)
```

### データポイント選択
```python
# main/case2_main.py
idx_sparse = select_sparse_data_indices(len(t_arr), exp_config.n_data, t_arr=t_arr)
```

両方とも正しく実装されているようです。

## 結論

**時間正規化の不整合は主要因ではない可能性が高い**

より可能性が高い原因:
1. **M3モデルの構造ミスマッチ** - 結合項/パラメータ不足
2. **校正に使ったデータ点が一部speciesのみ支配** - φ3, φ4が特に外れる
3. **尤度設計の問題** - M3でのspecies間の重み付け

実際の図を確認して、どのspeciesがどのように外れているかを詳細に分析する必要があります。
