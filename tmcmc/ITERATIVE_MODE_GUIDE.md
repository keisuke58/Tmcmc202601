# 反復実行モードガイド

**完璧な精度になるまで自動的に繰り返し実行**

---

## 🎯 概要

反復実行モード（`--iterative`）は、目標精度に達するまで自動的に実行を繰り返す機能です。

### 動作の流れ

```
1000パーティクル実行完了
    ↓
自動レビュー
    ↓
目標精度チェック
    ↓
未達成 → 設定を自動調整 → 再実行
    ↓
達成 → 🎉 完了
```

---

## 📊 デフォルト目標基準

- **ESS_min**: ≥ 300
- **RMSE**: ≤ 0.02
- **ステータス**: PASS
- **収束**: 必須

---

## 🚀 使用方法

### 基本的な使い方

```cmd
cd "C:\Users\nishioka\Neuer Ordner\tmcmc_docs\tmcmc"
python auto_run_5000_after_1000.py --wait-for-run-id m1_1000_20260118_083726 --iterative
```

### カスタム目標を設定

```cmd
python auto_run_5000_after_1000.py \
  --wait-for-run-id m1_1000_20260118_083726 \
  --iterative \
  --target-ess-min 500 \
  --target-rmse-max 0.01 \
  --max-iterations 5
```

---

## 🔄 反復ごとの設定

### 反復1回目
- **パーティクル数**: 5000
- **ステージ数**: 30
- **Mutation steps**: 5
- **チェーン数**: 1

### 反復2回目
- **パーティクル数**: 5000
- **ステージ数**: 40（増加）
- **Mutation steps**: 7（増加）
- **チェーン数**: 1

### 反復3回目以降
- **パーティクル数**: 8000（増加）
- **ステージ数**: 50（増加）
- **Mutation steps**: 10（増加）
- **チェーン数**: 3（増加、収束診断のため）

---

## 📈 自動調整ロジック

### ESS_minが低い場合
- ESS_min < 200 → パーティクル数8000、ステージ数40以上に自動調整

### RMSEが高い場合
- RMSE > 0.03 → ステージ数40以上、Mutation steps 7以上に自動調整

---

## ✅ 目標達成の判定

以下のすべての条件を満たすと目標達成と判定されます：

1. **ESS_min ≥ 目標値**（デフォルト: 300）
2. **RMSE ≤ 目標値**（デフォルト: 0.02）
3. **ステータス = 目標ステータス**（デフォルト: PASS）
4. **収束 = True**

---

## 📋 実行例

### 例1: デフォルト目標で反復実行

```cmd
python auto_run_5000_after_1000.py --wait-for-run-id m1_1000_20260118_083726 --iterative
```

**期待される動作**:
- 反復1: 5000パーティクル、30ステージ
- 反復2: 5000パーティクル、40ステージ（目標未達成の場合）
- 反復3: 8000パーティクル、50ステージ（目標未達成の場合）
- 目標達成時に自動停止

### 例2: より厳しい目標

```cmd
python auto_run_5000_after_1000.py \
  --wait-for-run-id m1_1000_20260118_083726 \
  --iterative \
  --target-ess-min 500 \
  --target-rmse-max 0.01
```

### 例3: 最大5回まで繰り返す

```cmd
python auto_run_5000_after_1000.py \
  --wait-for-run-id m1_1000_20260118_083726 \
  --iterative \
  --max-iterations 5
```

---

## ⚠️ 注意事項

1. **実行時間**: 反復実行は長時間かかる可能性があります
   - 反復1: 約10-20時間
   - 反復2: 約15-25時間
   - 反復3: 約20-30時間

2. **リソース**: メモリとCPUを大量に使用します

3. **最大反復回数**: デフォルトは3回。`--max-iterations`で変更可能

4. **目標未達成**: 最大反復回数に達しても目標未達成の場合は、実行を終了します

---

## 📁 生成されるファイル

各反復ごとに以下が生成されます：

- `REVIEW_1000_particles.md` - レビューレポート
- `REPORT.md` - 実行レポート
- `metrics.json` - メトリクス
- `figures/` - 可視化結果

---

## 🎉 目標達成時

目標精度を達成すると、以下のメッセージが表示されます：

```
🎉 目標精度を達成しました！
達成項目:
  ✅ ESS_min: 350.23 ≥ 300
  ✅ RMSE: 0.018 ≤ 0.02
  ✅ ステータス: PASS

反復回数: 2/3
最終実行ID: m1_5000_20260118_120000
```

---

**作成日**: 2026-01-18


