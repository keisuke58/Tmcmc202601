# ⚠️ 重要な発見: M1の推定誤差がM3に伝播

## 発見内容

### M1の推定誤差が大きい

**完了済みの実行結果から確認** (`m1_1000_20260118_083726_good`):

| 指標 | MAP | MEAN |
|------|-----|------|
| **RMSE** | **0.1646** | **0.2776** |
| **最大絶対誤差** | **0.266** | **0.425** |
| **最大相対誤差** | **23.62%** | **41.69%** |

### 推定誤差の詳細

**theta_true (M1)**: `[0.8, 2.0, 1.0, 0.1, 0.2]`

**MAP_M1**: `[0.611, 2.266, 0.832, 0.092, 0.226]`
- 誤差: `[-0.189, 0.266, -0.168, -0.008, 0.026]`
- **特にa12の誤差が大きい（+0.266）**

**MEAN_M1**: `[0.466, 2.425, 0.699, 0.065, 0.240]`
- 誤差: `[-0.334, 0.425, -0.301, -0.035, 0.040]`
- **より大きな誤差**

### M3への影響

**M3推定時のベース誤差**:
- **ベースRMSE (MAP使用)**: **0.3013**
- **ベースRMSE (MEAN使用)**: **0.3556**

**これは非常に大きい誤差です！**

## 原因の確定

### ✅ 確定: M1/M2の推定誤差がM3に伝播している

**根拠**:
1. M1の推定誤差が大きい（RMSE: 0.1646, 最大相対誤差: 23.62%）
2. M3推定時にM1/M2のMAP推定値を使用
3. M3推定時のベース誤差が大きい（RMSE: 0.3013）
4. データ生成時はtheta_trueを使用、推定時は誤差を含む値を使用

**この不整合がM3の適合性低下の主要原因です。**

## 影響の大きさ

### M1の推定誤差の影響

- **a11**: -0.189（-23.6%）
- **a12**: +0.266（+13.3%）⭐ **特に大きい**
- **a22**: -0.168（-16.8%）
- **b1**: -0.008（-8.1%）
- **b2**: +0.026（+12.8%）

### M3への伝播

M3推定時に使用されるベース値:
- M1部分: 誤差を含むMAP推定値
- M2部分: 誤差を含むMAP推定値（推定）
- M3部分: prior mean（1.5）

**M3のデータ生成時**: theta_trueの全パラメータを使用
**M3の推定時**: 誤差を含むM1/M2推定値 + M3パラメータのみ

**この不整合が残差の原因です。**

## 推奨される対策（優先順位順）

### 1. M1/M2の推定精度を向上 ⭐ 最優先

**現在の設定**:
- パーティクル数: 1000
- ステージ数: 50

**推奨設定**:
- パーティクル数: **5000以上**
- ステージ数: **100以上**
- Mutation steps: **10以上**

**期待効果**:
- M1/M2の推定誤差を50%以上削減
- M3の適合性が大幅に改善

### 2. M3データ生成と推定の一貫性確保

**オプションA**: M3データ生成時にM1/M2推定結果を使用
- データ生成と推定で同じベース値を使用
- 一貫性が確保される

**オプションB**: M3推定時にtheta_trueを使用（理想的なケース）
- 真値を使用するため最適
- 実データでは不可能

### 3. 階層的ベイズの完全実装

**現在**: M1/M2の点推定（MAP）をM3に使用
**改善**: M1/M2の不確実性をM3に伝播
- M1/M2のposterior分布をM3に統合
- より正確な不確実性の評価

### 4. M3で推定するパラメータの範囲を拡大

**現在**: 種間相互作用のみ（4パラメータ）
**改善**: M1/M2のパラメータも再推定
- より柔軟なモデル
- ただし計算コストが増加

## 次のアクション

### 即座に実施すべき

1. **実行完了を待つ**
   - 現在の実行（20260122_162052_debug_seed42）が完了したら
   - M1/M2の実際の推定誤差を確認

2. **M1/M2の推定精度向上**
   - パーティクル数: 1000 → 5000
   - ステージ数: 50 → 100
   - 新しい実行を開始

3. **M3データ生成の一貫性確保**
   - データ生成時にM1/M2推定結果を使用するオプションを追加
   - または、M3推定時にtheta_trueを使用（検証用）

### 中期的対策

1. **階層的ベイズの実装**
   - M1/M2の不確実性をM3に伝播
   - より正確な不確実性の評価

2. **Posterior Predictive Check**
   - M3のposterior predictive bandを可視化
   - データが予測区間内に収まっているか確認

## 結論

**M1/M2の推定誤差がM3に伝播していることが確定しました。**

**対策**:
1. M1/M2の推定精度を向上させる（最優先）
2. M3データ生成と推定の一貫性を確保する
3. 階層的ベイズを完全実装する

これにより、M3の適合性が大幅に改善されることが期待されます。
